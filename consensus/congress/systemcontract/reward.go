package systemcontract

import (
	"github.com/ethereum/go-ethereum/consensus/congress/vmcaller"
	"math"
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

var (
	rewardAdmin        = common.HexToAddress("0x69f76A1A210cC2495507C13204FCa5ae98ab9Bba")
	rewardAdminTestnet = common.HexToAddress("0x63de89702A3ed8b92E9cA9D323d7bDF665d3D02c")
)

const (
	rewardCode = "0x6080604052600436106101c65760003560e01c806371a1bb75116100f7578063c4d66de811610095578063e567cad611610064578063e567cad6146104e8578063ec0cb3361461024c578063f3b1cc67146104fd578063f851a44014610512576101cd565b8063c4d66de81461044a578063c885bc581461047d578063c967f90f14610492578063e4c335dd146104be576101cd565b8063837833b6116100d1578063837833b6146103c35780638f283970146103d85780639001eed81461040b578063c457f58014610420576101cd565b806371a1bb7514610384578063741579b1146103995780637dc0d1d0146103ae576101cd565b806322d502d41161016457806339ddcb181161013e57806339ddcb18146102ff578063425c8abd1461031457806344f999001461033e5780636b2fc2dc1461036f576101cd565b806322d502d4146102ab5780632cc93e82146102d55780632e4f67e41461024c576101cd565b8063158ef93e116101a0578063158ef93e1461022357806315de360e1461024c5780631cb44dfc14610261578063228cb73314610296576101cd565b806303fab4f6146101d2578063087273d8146101f95780630e6361af1461020e576101cd565b366101cd57005b600080fd5b3480156101de57600080fd5b506101e7610527565b60408051918252519081900360200190f35b34801561020557600080fd5b506101e7610534565b34801561021a57600080fd5b506101e761053a565b34801561022f57600080fd5b50610238610540565b604080519115158252519081900360200190f35b34801561025857600080fd5b506101e7610549565b34801561026d57600080fd5b506102946004803603602081101561028457600080fd5b50356001600160a01b0316610550565b005b3480156102a257600080fd5b506101e76105eb565b3480156102b757600080fd5b50610294600480360360208110156102ce57600080fd5b50356105f1565b3480156102e157600080fd5b50610294600480360360208110156102f857600080fd5b50356106c4565b34801561030b57600080fd5b506101e7610797565b34801561032057600080fd5b506102946004803603602081101561033757600080fd5b503561079d565b34801561034a57600080fd5b50610353610829565b604080516001600160a01b039092168252519081900360200190f35b34801561037b57600080fd5b506101e761082f565b34801561039057600080fd5b50610353610835565b3480156103a557600080fd5b506101e761083b565b3480156103ba57600080fd5b50610353610847565b3480156103cf57600080fd5b506101e7610856565b3480156103e457600080fd5b50610294600480360360208110156103fb57600080fd5b50356001600160a01b031661085c565b34801561041757600080fd5b506101e7610952565b34801561042c57600080fd5b506102946004803603602081101561044357600080fd5b5035610960565b34801561045657600080fd5b506102946004803603602081101561046d57600080fd5b50356001600160a01b03166109ec565b34801561048957600080fd5b50610294610a69565b34801561049e57600080fd5b506104a7610c27565b6040805161ffff9092168252519081900360200190f35b3480156104ca57600080fd5b50610294600480360360208110156104e157600080fd5b5035610c2c565b3480156104f457600080fd5b506101e7610d04565b34801561050957600080fd5b506101e7610d0a565b34801561051e57600080fd5b50610353610d11565b68056bc75e2d6310000081565b60015481565b60035481565b60005460ff1681565b6201518081565b60005461010090046001600160a01b031633146105a1576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b600580546001600160a01b0319166001600160a01b0383169081179091556040517f09ad0a3595604db9b7aef0dbd4918cea3642b96bc65ad7c9fb501a1529becd7990600090a250565b60045481565b60005461010090046001600160a01b03163314610642576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b612710811115610689576040805162461bcd60e51b815260206004820152600d60248201526c496e76616c696420726174657360981b604482015290519081900360640190fd5b60028190556040805182815290517f030d2a5527e850a5d0ae32f3d3fea5bfc200a464ddba258e66c984507ac6c6e09181900360200190a150565b60005461010090046001600160a01b03163314610715576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b61271081111561075c576040805162461bcd60e51b815260206004820152600d60248201526c496e76616c696420726174657360981b604482015290519081900360640190fd5b60018190556040805182815290517f030d2a5527e850a5d0ae32f3d3fea5bfc200a464ddba258e66c984507ac6c6e09181900360200190a150565b60075481565b60005461010090046001600160a01b031633146107ee576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b60048190556040805182815290517f0a20771588202779c3c4cb1dedde6e8dcc8dbcb6739073bf52f4a7e8d49040269181900360200190a150565b61f00681565b60025481565b61f00581565b670de0b6b3a764000081565b6005546001600160a01b031681565b60085481565b806001600160a01b0381166108aa576040805162461bcd60e51b815260206004820152600f60248201526e496e76616c6964206164647265737360881b604482015290519081900360640190fd5b60005461010090046001600160a01b031633146108fb576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b60008054610100600160a81b0319166101006001600160a01b03858116820292909217808455604051919004909116917f927cc064d7b7fa546fa7706bc01845d27d06f15af3ae90a672cc44735928e96191a25050565b69010f0cf064dd5920000081565b60005461010090046001600160a01b031633146109b1576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b60088190556040805182815290517f16cdbf5bac3b3a4284e8e9e95a1ca50fe49e96cabd04e1af92bf4f5ee216bd169181900360200190a150565b60005460ff1615610a3a576040805162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015290519081900360640190fd5b6000805460ff196001600160a01b0390931661010002610100600160a81b031990911617919091166001179055565b3361f00514610abf576040805162461bcd60e51b815260206004820152601860248201527f56616c696461746f727320636f6e7472616374206f6e6c790000000000000000604482015290519081900360640190fd5b600454610acb57610c25565b600354610ad9576001546003555b60085415801590610af55750600854610af3904390610d25565b155b15610b0657610b02610d70565b6003555b6000610b2b612710610b25600354600454610e5890919063ffffffff16565b90610eb1565b905047811115610b3b5750610c25565b610bab61f0056001600160a01b031663be1ff5d96040518163ffffffff1660e01b815260040160206040518083038186803b158015610b7957600080fd5b505afa158015610b8d573d6000803e3d6000fd5b505050506040513d6020811015610ba357600080fd5b505182610ef3565b600454600090610bbb9083610fdd565b905047811115610bcc575050610c25565b61f0056001600160a01b03166372ad3452826040518263ffffffff1660e01b81526004016000604051808303818588803b158015610c0957600080fd5b505af1158015610c1d573d6000803e3d6000fd5b505050505050505b565b601581565b60005461010090046001600160a01b03163314610c7d576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b612710811115610cc9576040805162461bcd60e51b8152602060048201526012602482015271496e76616c69642070657263656e7461676560701b604482015290519081900360640190fd5b60078190556040805182815290517fb2d4f35fa6c276cb006cda166cf2900f7348e308290644682abf56ea01948d1d9181900360200190a150565b60065481565b6206270081565b60005461010090046001600160a01b031681565b6000610d6783836040518060400160405280601881526020017f536166654d6174683a206d6f64756c6f206279207a65726f000000000000000081525061101f565b90505b92915050565b600154600554600091906001600160a01b031615610e5357600554604080516317a6948f60e21b81526000600482015290516001600160a01b0390921691635e9a523c91602480820192602092909190829003018186803b158015610dd457600080fd5b505afa925050508015610df957506040513d6020811015610df457600080fd5b505160015b610e0257610e53565b806006541115610e4f57600654600090610e1c9083610fdd565b90506000610e3b600654610b2561271085610e5890919063ffffffff16565b90506007548110610e4c5760025493505b50505b6006555b905090565b600082610e6757506000610d6a565b82820282848281610e7457fe5b0414610d675760405162461bcd60e51b81526004018080602001828103825260218152602001806111b86021913960400191505060405180910390fd5b6000610d6783836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f0000000000008152506110be565b80471015610f48576040805162461bcd60e51b815260206004820152601d60248201527f416464726573733a20696e73756666696369656e742062616c616e6365000000604482015290519081900360640190fd5b6040516000906001600160a01b0384169083908381818185875af1925050503d8060008114610f93576040519150601f19603f3d011682016040523d82523d6000602084013e610f98565b606091505b5050905080610fd85760405162461bcd60e51b815260040180806020018281038252603a81526020018061117e603a913960400191505060405180910390fd5b505050565b6000610d6783836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250611123565b600081836110ab5760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b83811015611070578181015183820152602001611058565b50505050905090810190601f16801561109d5780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b508284816110b557fe5b06949350505050565b6000818361110d5760405162461bcd60e51b8152602060048201818152835160248401528351909283926044909101919085019080838360008315611070578181015183820152602001611058565b50600083858161111957fe5b0495945050505050565b600081848411156111755760405162461bcd60e51b8152602060048201818152835160248401528351909283926044909101919085019080838360008315611070578181015183820152602001611058565b50505090039056fe416464726573733a20756e61626c6520746f2073656e642076616c75652c20726563697069656e74206d61792068617665207265766572746564536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f77a26469706673582212204a5e573a800dd150515baf7e7ba233dec74cbe93d1b8df407b75082bf507a1e864736f6c634300060c0033"

	// testnet code has bug
	rewardCodeTestnet = "0x6080604052600436106101c65760003560e01c806371a1bb75116100f7578063c4d66de811610095578063e567cad611610064578063e567cad6146104e8578063ec0cb3361461024c578063f3b1cc67146104fd578063f851a44014610512576101cd565b8063c4d66de81461044a578063c885bc581461047d578063c967f90f14610492578063e4c335dd146104be576101cd565b8063837833b6116100d1578063837833b6146103c35780638f283970146103d85780639001eed81461040b578063c457f58014610420576101cd565b806371a1bb7514610384578063741579b1146103995780637dc0d1d0146103ae576101cd565b806322d502d41161016457806339ddcb181161013e57806339ddcb18146102ff578063425c8abd1461031457806344f999001461033e5780636b2fc2dc1461036f576101cd565b806322d502d4146102ab5780632cc93e82146102d55780632e4f67e41461024c576101cd565b8063158ef93e116101a0578063158ef93e1461022357806315de360e1461024c5780631cb44dfc14610261578063228cb73314610296576101cd565b806303fab4f6146101d2578063087273d8146101f95780630e6361af1461020e576101cd565b366101cd57005b600080fd5b3480156101de57600080fd5b506101e7610527565b60408051918252519081900360200190f35b34801561020557600080fd5b506101e7610534565b34801561021a57600080fd5b506101e761053a565b34801561022f57600080fd5b50610238610540565b604080519115158252519081900360200190f35b34801561025857600080fd5b506101e7610549565b34801561026d57600080fd5b506102946004803603602081101561028457600080fd5b50356001600160a01b0316610550565b005b3480156102a257600080fd5b506101e76105eb565b3480156102b757600080fd5b50610294600480360360208110156102ce57600080fd5b50356105f1565b3480156102e157600080fd5b50610294600480360360208110156102f857600080fd5b50356106c4565b34801561030b57600080fd5b506101e7610797565b34801561032057600080fd5b506102946004803603602081101561033757600080fd5b503561079d565b34801561034a57600080fd5b50610353610829565b604080516001600160a01b039092168252519081900360200190f35b34801561037b57600080fd5b506101e761082f565b34801561039057600080fd5b50610353610835565b3480156103a557600080fd5b506101e761083b565b3480156103ba57600080fd5b50610353610847565b3480156103cf57600080fd5b506101e7610856565b3480156103e457600080fd5b50610294600480360360208110156103fb57600080fd5b50356001600160a01b031661085c565b34801561041757600080fd5b506101e7610952565b34801561042c57600080fd5b506102946004803603602081101561044357600080fd5b5035610960565b34801561045657600080fd5b506102946004803603602081101561046d57600080fd5b50356001600160a01b03166109ec565b34801561048957600080fd5b50610294610a69565b34801561049e57600080fd5b506104a7610c1f565b6040805161ffff9092168252519081900360200190f35b3480156104ca57600080fd5b50610294600480360360208110156104e157600080fd5b5035610c24565b3480156104f457600080fd5b506101e7610cfc565b34801561050957600080fd5b506101e7610d02565b34801561051e57600080fd5b50610353610d09565b68056bc75e2d6310000081565b60015481565b60035481565b60005460ff1681565b6201518081565b60005461010090046001600160a01b031633146105a1576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b600580546001600160a01b0319166001600160a01b0383169081179091556040517f09ad0a3595604db9b7aef0dbd4918cea3642b96bc65ad7c9fb501a1529becd7990600090a250565b60045481565b60005461010090046001600160a01b03163314610642576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b612710811115610689576040805162461bcd60e51b815260206004820152600d60248201526c496e76616c696420726174657360981b604482015290519081900360640190fd5b60028190556040805182815290517f030d2a5527e850a5d0ae32f3d3fea5bfc200a464ddba258e66c984507ac6c6e09181900360200190a150565b60005461010090046001600160a01b03163314610715576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b61271081111561075c576040805162461bcd60e51b815260206004820152600d60248201526c496e76616c696420726174657360981b604482015290519081900360640190fd5b60018190556040805182815290517f030d2a5527e850a5d0ae32f3d3fea5bfc200a464ddba258e66c984507ac6c6e09181900360200190a150565b60075481565b60005461010090046001600160a01b031633146107ee576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b60048190556040805182815290517f0a20771588202779c3c4cb1dedde6e8dcc8dbcb6739073bf52f4a7e8d49040269181900360200190a150565b61f00681565b60025481565b61f00581565b670de0b6b3a764000081565b6005546001600160a01b031681565b60085481565b806001600160a01b0381166108aa576040805162461bcd60e51b815260206004820152600f60248201526e496e76616c6964206164647265737360881b604482015290519081900360640190fd5b60005461010090046001600160a01b031633146108fb576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b60008054610100600160a81b0319166101006001600160a01b03858116820292909217808455604051919004909116917f927cc064d7b7fa546fa7706bc01845d27d06f15af3ae90a672cc44735928e96191a25050565b69010f0cf064dd5920000081565b60005461010090046001600160a01b031633146109b1576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b60088190556040805182815290517f16cdbf5bac3b3a4284e8e9e95a1ca50fe49e96cabd04e1af92bf4f5ee216bd169181900360200190a150565b60005460ff1615610a3a576040805162461bcd60e51b8152602060048201526013602482015272105b1c9958591e481a5b9a5d1a585b1a5e9959606a1b604482015290519081900360640190fd5b6000805460ff196001600160a01b0390931661010002610100600160a81b031990911617919091166001179055565b3361f00514610abf576040805162461bcd60e51b815260206004820152601860248201527f56616c696461746f727320636f6e7472616374206f6e6c790000000000000000604482015290519081900360640190fd5b600454610acb57610c1d565b60015460035560085415801590610aed5750600854610aeb904390610d1d565b155b15610afe57610afa610d68565b6003555b6000610b23612710610b1d600354600454610e5090919063ffffffff16565b90610ea9565b905047811115610b335750610c1d565b610ba361f0056001600160a01b031663be1ff5d96040518163ffffffff1660e01b815260040160206040518083038186803b158015610b7157600080fd5b505afa158015610b85573d6000803e3d6000fd5b505050506040513d6020811015610b9b57600080fd5b505182610eeb565b600454600090610bb39083610fd5565b905047811115610bc4575050610c1d565b61f0056001600160a01b03166372ad3452826040518263ffffffff1660e01b81526004016000604051808303818588803b158015610c0157600080fd5b505af1158015610c15573d6000803e3d6000fd5b505050505050505b565b601581565b60005461010090046001600160a01b03163314610c75576040805162461bcd60e51b815260206004820152600a60248201526927b7363c9030b236b4b760b11b604482015290519081900360640190fd5b612710811115610cc1576040805162461bcd60e51b8152602060048201526012602482015271496e76616c69642070657263656e7461676560701b604482015290519081900360640190fd5b60078190556040805182815290517fb2d4f35fa6c276cb006cda166cf2900f7348e308290644682abf56ea01948d1d9181900360200190a150565b60065481565b6206270081565b60005461010090046001600160a01b031681565b6000610d5f83836040518060400160405280601881526020017f536166654d6174683a206d6f64756c6f206279207a65726f0000000000000000815250611017565b90505b92915050565b600154600554600091906001600160a01b031615610e4b57600554604080516317a6948f60e21b81526000600482015290516001600160a01b0390921691635e9a523c91602480820192602092909190829003018186803b158015610dcc57600080fd5b505afa925050508015610df157506040513d6020811015610dec57600080fd5b505160015b610dfa57610e4b565b806006541115610e4757600654600090610e149083610fd5565b90506000610e33600654610b1d61271085610e5090919063ffffffff16565b90506007548110610e445760025493505b50505b6006555b905090565b600082610e5f57506000610d62565b82820282848281610e6c57fe5b0414610d5f5760405162461bcd60e51b81526004018080602001828103825260218152602001806111b06021913960400191505060405180910390fd5b6000610d5f83836040518060400160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f0000000000008152506110b6565b80471015610f40576040805162461bcd60e51b815260206004820152601d60248201527f416464726573733a20696e73756666696369656e742062616c616e6365000000604482015290519081900360640190fd5b6040516000906001600160a01b0384169083908381818185875af1925050503d8060008114610f8b576040519150601f19603f3d011682016040523d82523d6000602084013e610f90565b606091505b5050905080610fd05760405162461bcd60e51b815260040180806020018281038252603a815260200180611176603a913960400191505060405180910390fd5b505050565b6000610d5f83836040518060400160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f77000081525061111b565b600081836110a35760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b83811015611068578181015183820152602001611050565b50505050905090810190601f1680156110955780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b508284816110ad57fe5b06949350505050565b600081836111055760405162461bcd60e51b8152602060048201818152835160248401528351909283926044909101919085019080838360008315611068578181015183820152602001611050565b50600083858161111157fe5b0495945050505050565b6000818484111561116d5760405162461bcd60e51b8152602060048201818152835160248401528351909283926044909101919085019080838360008315611068578181015183820152602001611050565b50505090039056fe416464726573733a20756e61626c6520746f2073656e642076616c75652c20726563697069656e74206d61792068617665207265766572746564536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f77a2646970667358221220f0470ef2a12457ec99ddeb3459d014acfc149a5021c97431c9d3808de83bd8a664736f6c634300060c0033"
)

type hardForkReward struct {
}

func (s *hardForkReward) GetName() string {
	return RewardContractName
}

func (s *hardForkReward) Update(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	code := s.getCodeByChainId(config.GetChainId(height), height)
	contractCode := common.FromHex(code)

	//write rewardCode to sys contract
	state.SetCode(RewardContractAddr, contractCode)
	log.Debug("Write code to reward contract account", "addr", RewardContractAddr.String(), "code", code)

	return
}

func (s *hardForkReward) getAdminByChainId(chainId *big.Int, header *types.Header) common.Address {
	if chainId.Cmp(params.MainnetChainConfig.GetChainId(header.Number)) == 0 {
		return rewardAdmin
	}

	return rewardAdminTestnet
}

func (s *hardForkReward) getCodeByChainId(chainId *big.Int, number *big.Int) string {
	if chainId.Cmp(params.MainnetChainConfig.GetChainId(number)) == 0 {
		return rewardCode
	}

	return rewardCodeTestnet
}

func (s *hardForkReward) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	method := "initialize"
	data, err := GetInteractiveABI()[RewardContractName].Pack(method, s.getAdminByChainId(config.GetChainId(header.Number), header))
	if err != nil {
		log.Error("Can't pack data for initialize", "error", err)
		return err
	}

	msg := vmcaller.NewLegacyMessage(header.Coinbase, &RewardContractAddr, 0, new(big.Int), math.MaxUint64, new(big.Int), data, false)
	_, err = vmcaller.ExecuteMsg(msg, state, header, chainContext, config)

	return
}
